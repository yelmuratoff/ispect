name: Sync Versions, Changelogs, and READMEs

on:
   push:
      branches:
         - "**"
      branches-ignore:
         - "auto/sync/**"
      paths:
         - "CHANGELOG.md"
         - "version.config"
         - "README.md"
         - ".github/workflows/sync_versions_and_changelogs.yml"
         - "bash/update_versions.sh"
         - "bash/update_changelog.sh"
         - "bash/sync_readme.sh"

jobs:
   update-versions-changelogs-readmes:
      runs-on: ubuntu-latest
      permissions:
         contents: write
         pull-requests: write

      steps:
         - name: Checkout code
            uses: actions/checkout@v3
            with:
               fetch-depth: 0

         - name: Setup Git
            run: |
               git config --global user.name "GitHub Actions"
               git config --global user.email "actions@github.com"

         - name: Update package versions and CHANGELOGs
            run: |
               chmod +x bash/update_versions.sh
               ./bash/update_versions.sh

         - name: Sync README to all packages
            run: |
               chmod +x bash/sync_readme.sh
               ./bash/sync_readme.sh

         - name: Verify Dependencies
            run: |
               chmod +x bash/check_dependencies.sh
               ./bash/check_dependencies.sh || echo "Dependency check found issues, but continuing with commit as update_versions.sh should have fixed them"

         - name: Prepare changes for PR
            id: prepare_diff
            run: |
               # Clean up any temporary files
               find packages -name "*.tmp" -type f -delete || true

               # Print diagnostic output for debugging
               git status --porcelain || true
               git diff --name-only || true

               # Write changed file list and register as an output for subsequent steps
               changes=$(git diff --name-only || true)
               if [[ -z "$changes" ]]; then
                  changes="(no changes)"
               fi
               echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
               echo "$changes" >> "$GITHUB_OUTPUT"
               echo "EOF" >> "$GITHUB_OUTPUT"

         - name: Create Pull Request (if changes)
            id: create_pr
            uses: peter-evans/create-pull-request@v5
            with:
               token: ${{ secrets.GITHUB_TOKEN }}
               commit-message: "chore: sync package versions, changelogs, and READMEs with dependencies"
               branch: "auto/sync/${{ github.sha }}"
               title: "chore: sync package versions & README updates"
               body: |
                  This PR was created by CI to sync package versions, changelogs, and README files.
                  The update was generated by the project's automation tools.
               labels: "auto-sync"
               assignees: "yelmuratoff"
               reviewers: "yelmuratoff"

         - name: Comment PR with summary
            if: ${{ steps.create_pr.outputs.pull-request-number != '' }}
            uses: peter-evans/create-or-update-comment@v2
            with:
               token: ${{ secrets.GITHUB_TOKEN }}
               issue-number: ${{ steps.create_pr.outputs.pull-request-number }}
               body: |
                  CI automated update detected changes in the following files:
                  ```
                  ${{ steps.prepare_diff.outputs.changed_files }}
                  ```
